<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Osmium</title>
		<link href="style.css" rel="stylesheet" type ="text/css"/>
		<link href="favicon.ico" rel="icon" type="image/png">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="scripts.js"></script> 
		<script src="https://www.gstatic.com/charts/loader.js"></script>
		<script>
			google.charts.load('current');
		</script>
		<script async defer src="https://apis.google.com/js/api.js" 
			onload="this.onload=function(){};loadAuth()" 
			onreadystatechange="if (this.readyState === 'complete') this.onload()">
		</script>
		<!-- Vue Styling -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round" rel="stylesheet">
		<!-- <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet"> -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
	</head>
	<body class="bigbody">
		<div id="push-success-popup" class="bigpopup pretty-scrollbar-light">
			<div class="content">
				<div id="push-success-title" class="title-center fullsize"></div>
				<div id="push-success-message" class="medium-text center-h"></div>
				<div class="small-spacer"></div>
				<div id="push-tech-message" class="large-text center-h" style="display: none;">Bonus Text
				<div class='small-text center-h'>Mini Text</div>
				<div class="small-spacer"></div></div>
				<button class="big" onclick="this.parentElement.parentElement.classList.remove('visible')">Ok</div>
			</div>
		</div>
		<div class="fixedratio">
			<div id="sign-in-popup" class="bigpopup pretty-scrollbar-light">
				<div class="content">
					<div class="title-center fullsize fullwidth">Sign In to the Library</div>
					<i class="material-icons">perm_identity</i>
					<input id="sign-in-id" type="text" placeholder="Student ID"></input>
					<button id='sign-in-loading' class="material-icons big ok" onclick="throwSignIn()"></button>
					<button class="material-icons big cancel" onclick='showSignIn(false);'>close</button>
				</div>
				<div class="content-extra">
					<div class="medium-text title-left">I'm here to...</div>
					<label class="checkbox-container">
						Work/Study/Read
						<input id='work-checkbox' type="checkbox">
						<span class="checkmark"></span>
						<i class='material-icons'>menu_book</i>
					</label>
					<label class="checkbox-container">
						Get Tech Help
						<input id='tech-help-checkbox' type="checkbox">
						<span class="checkmark"></span>
						<i class='material-icons'>phonelink</i>
					</label>
					<label class="checkbox-container">
						Print Documents
						<input id='print-checkbox' type="checkbox">
						<span class="checkmark"></span>
						<i class='material-icons'>print</i>
					</label>
					<label class="checkbox-container">
						Borrow/Return Laptop
						<input id='loaner-checkbox' type="checkbox">
						<span class="checkmark"></span>
						<i class='material-icons'>laptop_chromebook</i>
					</label>
				</div>
				<div class="numpad">
					<button class="num7" onclick="numpadInput('sign-in-id',this.innerText);">7</button>
					<button class="num8" onclick="numpadInput('sign-in-id',this.innerText);">8</button>
					<button class="num9" onclick="numpadInput('sign-in-id',this.innerText);">9</button>
					
					<button class="num4" onclick="numpadInput('sign-in-id',this.innerText);">4</button>
					<button class="num5" onclick="numpadInput('sign-in-id',this.innerText);">5</button>
					<button class="num6" onclick="numpadInput('sign-in-id',this.innerText);">6</button>
					
					<button class="num1" onclick="numpadInput('sign-in-id',this.innerText);">1</button>
					<button class="num2" onclick="numpadInput('sign-in-id',this.innerText);">2</button>
					<button class="num3" onclick="numpadInput('sign-in-id',this.innerText);">3</button>
					
					<button class="num0" onclick="numpadInput('sign-in-id',this.innerText);">0</button>
					<button class="numbs" onclick="numpadInput('sign-in-id',this.innerText);">backspace</button>
				</div>
			</div>
			<div id="sign-out-popup" class="bigpopup pretty-scrollbar-light">
				<div class="content">
					<div class="title-center fullsize fullwidth">Sign Out of the Library</div>
					<i class="material-icons">perm_identity</i>
					<input id="sign-out-id" type="text" placeholder="Student ID"></input>
					<button id='sign-out-loading' class="material-icons big ok" onclick="throwSignOut()"></button>
					<button class="material-icons big cancel" onclick='showSignOut(false);'>close</button>
				</div>
				<div class="content-extra">
					<div class='large-text'>
					Thanks for visiting!
					</div>
				</div>
				<div class="numpad">
					<button class="num7" onclick="numpadInput('sign-out-id',this.innerText);">7</button>
					<button class="num8" onclick="numpadInput('sign-out-id',this.innerText);">8</button>
					<button class="num9" onclick="numpadInput('sign-out-id',this.innerText);">9</button>
					
					<button class="num4" onclick="numpadInput('sign-out-id',this.innerText);">4</button>
					<button class="num5" onclick="numpadInput('sign-out-id',this.innerText);">5</button>
					<button class="num6" onclick="numpadInput('sign-out-id',this.innerText);">6</button>
					
					<button class="num1" onclick="numpadInput('sign-out-id',this.innerText);">1</button>
					<button class="num2" onclick="numpadInput('sign-out-id',this.innerText);">2</button>
					<button class="num3" onclick="numpadInput('sign-out-id',this.innerText);">3</button>
					
					<button class="num0" onclick="numpadInput('sign-out-id',this.innerText);">0</button>
					<button class="numbs" onclick="numpadInput('sign-out-id',this.innerText);">backspace</button>
				</div>
			</div>
			
			<div class='pretty-scrollbar-dark'>
				<div class='fullsize title-center logotext'>Welcome to the Library</div>
				<div class='medium-spacer'></div>
				<button class="sign-in big" onclick="showSignIn(true);">Sign In</button>
				<div class='medium-spacer'></div>
				<button class="sign-out big" onclick="showSignOut(true);">Sign Out</button>
			</div>
		</div>
	</body>
</html>

<script>
function showError(errorname) {
	switch (errorname) {
		case 'no-url-database':
			throw new Error("CRITICAL ERROR: No database selected.");
			break;
		case 'auth-lost':
			throw new Error("CRITICAL ERROR: Authentication lost.");
			break;
	}
}

document.getElementById('sign-in-id').addEventListener("keydown", function(event) {
    event.preventDefault();
	if (event.keyCode === 13) {
		throwSignIn();
	} else {
		numpadInput('sign-in-id',event.key.toLowerCase());
    }
});
document.getElementById('sign-out-id').addEventListener("keydown", function(event) {
    event.preventDefault();
	if (event.keyCode == 13) {
		throwSignOut();
	} else {
		numpadInput('sign-out-id',event.key.toLowerCase());
	}
});

function showSignIn(state) {
	if (state == true) {
		document.getElementById('sign-in-popup').classList.add('visible');
		setTimeout(function(){document.getElementById('sign-in-id').focus()},250);
	} else {
		document.getElementById('sign-in-popup').classList.remove('visible');
		document.getElementById("sign-in-id").value = "";
		document.getElementById('work-checkbox').checked = false;
		document.getElementById('tech-help-checkbox').checked = false;
		document.getElementById('print-checkbox').checked = false;
		document.getElementById('loaner-checkbox').checked = false;
		document.getElementById('sign-in-loading').classList.remove('loading');
		signInHTMLSTATE = 0;
	}
}
// states for UI callbacks
// 0 - not active / user closed UI
// 1 - sending query / awaiting response
var signInHTMLSTATE = 0;
function throwSignIn() {
	if (signInHTMLSTATE == 0) { //prevent double submission
		var studentid = document.getElementById('sign-in-id').value;
		if ((studentid.length > 0)&&(studentid.length <= 6)) {
			document.getElementById('sign-in-loading').classList.add('loading');
			pushEvent(studentid, 'sign-in', '', [document.getElementById('work-checkbox').checked, document.getElementById('tech-help-checkbox').checked, document.getElementById('print-checkbox').checked, document.getElementById('loaner-checkbox').checked]);
			signInHTMLSTATE = 1;
		}
	}
}
function showSignOut(state) {
	if (state == true) {
		document.getElementById('sign-out-popup').classList.add('visible');
		setTimeout(function(){document.getElementById('sign-out-id').focus()},250);
	} else {
		document.getElementById('sign-out-popup').classList.remove('visible');
		document.getElementById("sign-out-id").value = "";
		document.getElementById('sign-out-loading').classList.remove('loading');
		signOutHTMLSTATE = 0;
	}
}
// states for UI callbacks
// 0 - not active / user closed UI
// 1 - sending query / awaiting response
var signOutHTMLSTATE = 0;
function throwSignOut() {
	if (signOutHTMLSTATE == 0) { //prevent double submission
		var studentid = document.getElementById('sign-out-id').value;
		if ((studentid.length > 0)&&(studentid.length <= 6)) {
			document.getElementById('sign-out-loading').classList.add('loading');
			pushEvent(studentid, 'sign-out', '', [false,false,false,false]);
			signOutHTMLSTATE = 1;
		}
	}
}

function catchPushEvent(name, type, flags) {
	var message = document.getElementById('push-success-message');
	var bonus = document.getElementById('push-tech-message');
	bonus.classList.remove('tech');
	bonus.classList.remove('loaner');
	if (flags[1]) {
		bonus.classList.add('tech');

	} else if (flags[3]) {
		bonus.classList.add('loaner');
	}
	if (type == 'sign-in') {
		if (signInHTMLSTATE == 1) { //don't touch UI if already closed
			showSignIn(false);
		}
		document.getElementById('push-success-title').textContent = "Welcome, "+name;
		message.textContent = "You've been signed in. Enjoy your stay!";
	} else {
		if (signOutHTMLSTATE == 1) { //don't touch UI if already closed
			showSignOut(false);
		}
		document.getElementById('push-success-title').textContent = "Goodbye, "+name;
		message.textContent = "You've been signed out. See you next time!";
	}
	document.getElementById('push-success-popup').classList.add('visible');
	console.log(name+' '+type+' '+flags);

}

function numpadInput(targetid,value) {
	var target = document.getElementById(targetid);
	if (value == "backspace") {
		if (target.value.length > 0) {
			target.value = target.value.substring(0,target.value.length-1);
		}
	} else if ((isNaN(value) == false)&&(target.value.length < 6)) {
		target.value += value;
	}
}

function onAuthUpdate() {
	selectDatabaseIdFromUrl();
	if (!(GoogleAuth.isSignedIn.get())) {
		showError('auth-lost');
	}
}

</script>