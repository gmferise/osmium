<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Osmium</title>
		<link href="style.css" rel="stylesheet" type ="text/css"/>
		<link href="favicon.ico" rel="icon" type="image/png">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="scripts.js"></script> 
		<script src="https://www.gstatic.com/charts/loader.js"></script>
		<script>
			google.charts.load('current');
		</script>
		<script async defer src="https://apis.google.com/js/api.js" 
			onload="this.onload=function(){};loadAuth()" 
			onreadystatechange="if (this.readyState === 'complete') this.onload()">
		</script>
		<!-- Vue Styling -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round" rel="stylesheet">
		<!-- <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet"> -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
	</head>
	<body class="color-bg-main">
		
		<div class="split-left pretty-scrollbar-dark">
			<div class="small-spacer"></div>
			<div class='middle-wrapper'>
				<div id='searchbar'>
					<i class="material-icons">search</i>
					<input type='text' id='searchfield' placeholder="Search"></input>
				</div>
			</div>
			<div class='middle-wrapper'>
				<div id='sortbar' class='sort-time-down'>
					<div id='sort-name' class="tablecell">
						<button onclick="toggleSort('sort-name');">
							<div class="sortfield">Name</div>
							<div class="updown">
							</div>
						</button>
					</div>
					<div id='sort-time' class="tablecell">
						<button onclick="toggleSort('sort-time');">
							<div class="sortfield">Time</div>
							<div class="updown">
							</div>
						</button>
					</div>
				</div>
			</div>
			<div id='cards-wrapper'>
				<div class="null-spacer" id="insert-cards"></div>
			</div>
		</div>
		
		<div class="split-right">
			<div id="overview-table" onclick="updateTodaysDate()">
				<div class="tablerow">
					<div id="todays-date" class="title-center">
						<div class="center-h medium-text">Loading...</div>
						<div class="center-h medium-text"></div>
						<div class="center-h medium-text" style="padding-bottom:10px;"></div>
					</div>
				</div>
				
				<div class="tablerow">
					<div class="title-center medium-text">In the Library</div>
					<div class="half-pair">
						<div class="left">
							<div id='signed-in-counter' class="large-text">0</div>
							<div class="small-text">Signed In</div>
						</div>
						<div class="middle"></div>
						<div class="right">
							<div id='signed-in-tech-counter' class="large-text">0</div>
							<div class="small-text">In Tech</div>
						</div>
					</div>
				</div>
				
				<div class="tablerow">
					<div class="title-center medium-text">Today's Traffic</div>
					<div class="half-pair">
						<div class="left">
							<div id='total-counter' class="large-text">0</div>
							<div class="small-text">Students</div>
						</div>
						<div class="middle"></div>
						<div class="right">
							<div id='total-tech-counter'class="large-text">0</div>
							<div class="small-text">Tech Visitors</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>

<script>
function showError(errorname) {
	switch (errorname) {
		case 'no-url-database':
			throw new Error("CRITICAL ERROR: No database selected.");
			break;
		case 'auth-lost':
			throw new Error("CRITICAL ERROR: Authentication lost.");
			break;
		case 'db-get-fail':
			throw new Error("ERROR: Could not update event list.");
	}
}

function get12time(date) {
	var hours = date.getHours();
	var minutes = date.getMinutes();
	var ampm = hours >= 12 ? 'pm' : 'am';
	hours = hours % 12;
	hours = hours ? hours : 12; // the hour '0' should be '12'
	minutes = minutes < 10 ? '0'+minutes : minutes;
	var strTime = hours + ':' + minutes + ' ' + ampm;
	return strTime;
}
	
var cards = [];
function cardObjectFromElement(element,numParents) {
	var el = element;
	if (numParents == null) {
		numParents = 0;
	}
	for (var i=0; i<numParents; i++) {
		el = el.parentElement;
	}
	return cards[Array.from(el.parentElement.children).indexOf(el)-1];
}

//OBJECT - Card
function new_Card(studentId, studentName, eventName, timestamp, comments, flags, isSentToTech) {
	const obj = {};
	obj.id = studentId;
	obj.name = studentName;
	obj.event = eventName;
	obj.time = timestamp;
	obj.comments = comments;
	obj.flags = flags;
	obj.tech = isSentToTech;
	
	//create card
	var wrap = document.createElement('div');	
		wrap.classList.add('check-card');
		var btn = document.createElement('button');
			btn.setAttribute('onclick','cardObjectFromElement(this,1).clickAction();');
			var hover = document.createElement('div');
				hover.classList.add('tooltip');
			btn.appendChild(hover);
		wrap.appendChild(btn);
		var txtwrap = document.createElement('div');
			txtwrap.classList.add('text-holder');
			var txtmed = document.createElement('div');
				txtmed.classList.add('medium-text');
				txtmed.innerHTML = obj.name;
				var hover = document.createElement('div');
					hover.classList.add('tooltip');
				txtmed.appendChild(hover);
			txtwrap.appendChild(txtmed);
			var txtsml = document.createElement('div');
				txtsml.classList.add('small-text');
				txtsml.innerHTML = get12time(obj.time);
			txtwrap.appendChild(txtsml);
		wrap.appendChild(txtwrap);
		
	obj.card = wrap;
	
	obj.showComments = function() {
		var popup = document.createElement('div');
			popup.classList.add('card-popup');
			var container = document.createElement('div');
			container.classList.add('card-popup-container','color-bg-main');
				var close = document.createElement('button');
					close.classList.add('close','material-icons');
					close.innerHTML = 'close';
					close.setAttribute('onclick','this.parentElement.parentElement.remove()');
				container.appendChild(close);
				var header = document.createElement('div');
					header.classList.add('title-center');
					header.innerHTML = obj.name;
				container.appendChild(header);
				var center = document.createElement('div');
					center.classList.add('middle-wrapper');
					var leftside = document.createElement('div');
						leftside.classList.add('left');
						
							var leftlabel = document.createElement('div');
								leftlabel.classList.add('title-left');
								leftlabel.innerHTML = "Student History";
							leftside.appendChild(leftlabel);
							
							var historylist = document.createElement('div');
								historylist.classList.add('pretty-scrollbar-dark');
								historylist.id = "student-history-wrapper";
								var loadtxt = document.createElement('i');
									loadtxt.classList.add('small-text');
									loadtxt.innerHTML = "Loading...";
								historylist.appendChild(loadtxt);
							leftside.appendChild(historylist)
							
					center.appendChild(leftside);
					var rightside = document.createElement('div');
						rightside.classList.add('right');
						var rightlabel = document.createElement('div');
							rightlabel.classList.add('title-center');
							rightlabel.innerHTML = "Notes for Event";
						rightside.appendChild(rightlabel);
						var flaglist = document.createElement('div');
							flaglist.id = 'comments-flags';
							var flagnames = ['library','tech','print'];
							for (var i=0; i<3; i++) {
								var flag = document.createElement('div');
									flag.classList.add(flagnames[i]);
								flaglist.appendChild(flag);
							}
						rightside.appendChild(flaglist);
						var commentsbox = document.createElement('textarea');
							commentsbox.setAttribute('placeholder','No notes for this event yet. Add some here!');
							commentsbox.innerText = "(Click an event to see and edit Notes.)";
							commentsbox.disabled = true;
							commentsbox.id = "comments-box";
						rightside.appendChild(commentsbox);
						var commentsstatus = document.createElement('div');
							commentsstatus.classList.add('small-text');
							commentsstatus.id = "comments-status";
						rightside.appendChild(commentsstatus);
					center.appendChild(rightside);
				container.appendChild(center);
			popup.appendChild(container);
		document.body.appendChild(popup);
		getStudentHistory(obj.id);
	}
	
	//click the card's button - uses card's properties to determine action
	obj.clickAction = function() {
		if (!(obj.tech) && (obj.event=="sign-in")) {
			//todo send "moved to tech" query
			//obj.updateStatusAndColor("sign-in",true);
			if (!(obj.card.classList.contains('loading'))) {
			pushEvent(obj.id, 'sent-tech', '', [false,false,false]);
				obj.card.classList.add('loading');
				pauseUpdate = 1;
				clearTimeout(pauseUpdateTimer);
				pauseUpdateTimer = setTimeout(function() {
					if (pauseUpdate == 2) {
						pauseUpdate = 0;
						updateTodaysDate();
					} else {
						pauseUpdate = 0;
					}
					},2500);
			}
		} else {
			obj.showComments();
		}
	}
	
	obj.playRefreshAnimation = function() {
		obj.card.classList.add('anim-refresh');
		setTimeout(function() {
			obj.card.classList.remove('anim-refresh');
		},500);
	}
	obj.playInsertAnimation = function() {
		obj.card.classList.add('anim-in');
		setTimeout(function() {
			obj.card.classList.remove('anim-in');
		},250);
	}
	obj.playLeaveAnimation = function() {
		obj.card.classList.add('anim-out');
		setTimeout(function() {
			obj.card.classList.remove('anim-out');
		},250);
	}
	
	//provide status name ("in"|"out") and tech status (true|false) to update proper styling and object's properties
	obj.updateStatusAndColor = function(statusName, isSentToTech, timestamp) {
		if (timestamp != null) {
			obj.time = timestamp;
		}
		var newcolor = "color-card_"+statusName;
		if (isSentToTech) {
			newcolor += '_tech';
		}
		obj.card.children[1].children[1].textContent = get12time(obj.time);
		obj.card.classList = "";
		obj.card.classList.add('check-card');
		obj.card.classList.add(newcolor);
		obj.event = statusName;
		obj.tech = isSentToTech;
	}
	obj.updateStatusAndColor(obj.event,obj.tech);
	
	//insert into cards list at top
	obj.insertIntoCards = function() {
		document.getElementById("insert-cards").insertAdjacentElement('afterEnd',obj.card);
	};
	
	return obj;
}

function randomDate() {
	var now = new Date();
	now.setHours(parseInt(Math.random()*24));
	now.setMinutes(parseInt(Math.random()*60));
	now.setSeconds(parseInt(Math.random()*60));
	return now;
}

function toggleSort(toggle) {
	var el = document.getElementById('sortbar');
	var current = el.classList[0];
	el.classList.remove(current);
	if (toggle == current.substring(0,9)) {
		if (current.substring(10) == "up") {
			el.classList.add(current.substring(0,9)+"-down");
			cards = cards.reverse();
			repackCards();
		} else {
			el.classList.add(current.substring(0,9)+"-up");
			cards = cards.reverse();
			repackCards();
		}
	} else if (current.substring(5,9)=="name") {
		el.classList.add("sort-time-down");
		cards = quickSort(cards, 0, cards.length-1, false);
		repackCards();
	} else {
		el.classList.add("sort-name-down");
		cards = quickSort(cards, 0, cards.length-1, true);
		repackCards();
	}
}
function reSort() {
	var el = document.getElementById('sortbar');
	var current = el.classList[0];
	
	if (current.substring(0,9) == "sort-time") {
		cards = quickSort(cards, 0, cards.length-1, false);
		if (current.substring(10) == "up") {
			cards = cards.reverse();
		}
		repackCards();
	} else {
		cards = quickSort(cards, 0, cards.length-1, true);
		if (current.substring(10) == "up") {
			cards = cards.reverse();
		}
		repackCards();
	}	
}
function repackCards() {
	var el = document.getElementById('cards-wrapper');
	el.innerHTML = '';
	var ns = document.createElement('div');
	ns.classList.add('null-spacer');
	ns.setAttribute('id','insert-cards');
	el.appendChild(ns);
	for (var i=cards.length-1; i>=0; i--) {
		cards[i].insertIntoCards();
	}
}

function QSswap(items, leftIndex, rightIndex){
    var temp = items[leftIndex];
    items[leftIndex] = items[rightIndex];
    items[rightIndex] = temp;
}
function QSpartition_name(items, left, right) {
    var pivot   = items[Math.floor((right + left) / 2)], //middle element
        i       = left, //left pointer
        j       = right; //right pointer
    while (i <= j) {
        while (items[i].name < pivot.name) {
            i++;
        }
        while (items[j].name > pivot.name) {
            j--;
        }
        if (i <= j) {
            QSswap(items, i, j); //sawpping two elements
            i++;
            j--;
        }
    }
    return i;
}
function QSpartition_time(items, left, right) {
    var pivot   = items[Math.floor((right + left) / 2)], //middle element
        i       = left, //left pointer
        j       = right; //right pointer
    while (i <= j) {
        while (items[i].time > pivot.time) {
            i++;
        }
        while (items[j].time < pivot.time) {
            j--;
        }
        if (i <= j) {
            QSswap(items, i, j); //sawpping two elements
            i++;
            j--;
        }
    }
    return i;
}
function quickSort(items, left, right, name) {
    var index;
    if (items.length > 1) {
		if (name) {
			index = QSpartition_name(items, left, right); //index returned from partition
		} else {
			index = QSpartition_time(items, left, right); //index returned from partition
		}
		
        if (left < index - 1) { //more elements on the left side of the pivot
            quickSort(items, left, index - 1, name);
        }
        if (index < right) { //more elements on the right side of the pivot
            quickSort(items, index, right, name);
        }
    }
    return items;
}

var lastResultsRefreshTime = new Date();
lastResultsRefreshTime.setHours(0);
lastResultsRefreshTime.setMinutes(0);
lastResultsRefreshTime.setSeconds(0);
lastResultsRefreshTime.setMilliseconds(0);
var pauseUpdate = 0;
var pauseUpdateTimer = null;
function updateTodaysDate() {
	//var now = new Date(new Date().getTime()+Math.random()*100000000000)
	if (pauseUpdate == 0) {
		var now = new Date();
		var s = now.toLocaleString('en-US',{weekday:'long',month:'long',day:'numeric'});
		var d = s.split(", ");
		d[0] += ",";
		d.push(get12time(now));
		var here = document.getElementById('todays-date');
		for (var i=0; i<d.length; i++) {
			here.children[i].innerHTML = d[i];
		}
		getEventsAfter(lastResultsRefreshTime);
		lastResultsRefreshTime = new Date();
		setTimeout(function(){updateTodaysDate();},60000-((now.getSeconds()*1000)+now.getMilliseconds())); //timeout to refresh on next minute
	} else {
		pauseUpdate = 2;
	}
}
function catchPushEvent(name, type, flags) {
	updateTodaysDate();
}

var preids = [];
var precards = [];
var tmpcards = [];

var finalcards = [];

function catchEventsAfter(response) {
	var dt = response.getDataTable();
	
	if (response.isError()) {
		showError('db-get-fail');
		return;
	}
	
	if (dt.getNumberOfRows() > 0) {
		for (var i=0; i<dt.getNumberOfRows(); i++) {
			var row = [];
			for (var j=0; j<dt.getNumberOfColumns(); j++) {
				row.push(dt.getValue(i,j));
			}
			
			var index = preids.indexOf(row[0]);
			if (index == -1) {
				console.log(row[1]+" new sign in");
				if (row[2] == 'sign-in') {
					preids.push(row[0]);
					precards.push([row]);
					var c = row;
					c = new_Card(c[0],c[1],c[2],c[3],c[4],[c[5],c[6],c[7]],false);
					tmpcards.push(c);
				}
			} else {
				var last = precards[index][precards[index].length-1][2];
				if (last == 'sign-in') {
					if (row[2] == 'sent-tech') { //sign-in -> tech
						precards[index].push(row);
						tmpcards[index].updateStatusAndColor('sign-in',true,row[3]);
					} else if (row[2] == 'sign-out') { //sign-in -> sign-out
						tmpcards[index].updateStatusAndColor('sign-out',tmpcards[index].tech,row[3]); //if was tech, keep tech
						finalcards.push(tmpcards.splice(index,1)[0]);
						
						preids.splice(index,1)[0];
						precards.splice(index,1)[0];
						//tmpcards.splice(index,1)[0]; already done in push
					} else if (row[2] == 'sign-in') { //sign-in -> sign-in (just end the first one);
						tmpcards[index].updateStatusAndColor('sign-out',tmpcards[index].tech,precards[index][precards[index].length-1][3]);//if was tech, keep tech
						finalcards.push(tmpcards[index]);
						
						precards[index] = [row];
						var c = row;
						c = new_Card(c[0],c[1],c[2],c[3],c[4],[c[5],c[6],c[7]],false);
						tmpcards[index] = c;
					}
				} else if (last == 'sent-tech') {
					if (row[2] == 'sign-out') { //sign-in -> tech -> sign-out
						var c = row;
						tmpcards[index].updateStatusAndColor('sign-out',true,row[3]);
						finalcards.push(tmpcards.splice(index,1)[0]);
						
						preids.splice(index,1)[0];
						precards.splice(index,1)[0];
						//tmpcards.splice(index,1)[0]; already done in push
					} else if (row[2] == 'sign-in') { //sign-in -> tech -> sign-in (end the first);
						tmpcards[index].updateStatusAndColor('sign-out',true,precards[index][precards[index].length-1][3]);
						finalcards.push(tmpcards[index]);
						
						precards[index] = [row];
						var c = row;
						c = new_Card(c[0],c[1],c[2],c[3],c[4],[c[5],c[6],c[7]],false); //if loaner tech true
						tmpcards[index] = c;
					}
				}
			}
		}
		cards = finalcards.concat(tmpcards);
		reSort(); //also repacks
		var signedIns = 0;
		var signedInTechs = 0;
		var total = 0;
		var totalTechs = 0;
		for (var i=0; i<cards.length; i++) {
			total++;
			if (cards[i].event == 'sign-in') {
				signedIns++;
				if (cards[i].tech) {
					signedInTechs++;
					totalTechs++;
				}
			} else if (cards[i].tech) {
				totalTechs++;
			}
		}
		document.getElementById('signed-in-counter').innerText = signedIns;
		document.getElementById('signed-in-tech-counter').innerText = signedInTechs;
		document.getElementById('total-counter').innerText = total;
		document.getElementById('total-tech-counter').innerText = totalTechs;
	}
}

var comments_eventset;
var commentsel = -1;
function catchStudentHistory(response){
	var dt = response.getDataTable();
	
	if (response.isError()) {
		showError('db-get-fail');
		return;
	}
	
	var dateset = [];
	var eventset = [[]];
	var lastdate = "";
	
	if (dt.getNumberOfRows() > 0) {
		for (var i=0; i<dt.getNumberOfRows(); i++) {
			var row = [];
			for (var j=0; j<dt.getNumberOfColumns(); j++) {
				row.push(dt.getValue(i,j));
			}
			
			var dstr = row[3].toLocaleString('en-US',{weekday:'long',month:'long',day:'numeric',year:'numeric'});
			if (lastdate == "") {
				lastdate = dstr;
			}
			if (dstr == lastdate) {
				eventset[eventset.length-1].push(row);
			} else {
				dateset.push(lastdate); 				//close previous date by pushing it
				eventset.push([]);						//close prev list by adding a new one	
				eventset[eventset.length-1].push(row); 	//push new one's row				
				lastdate = dstr;						//remember this new day
			}
			
		}
		dateset.push(lastdate); //close last date by pushing it
		var wrap = document.getElementById('student-history-wrapper');
		wrap.innerHTML = "";
		for (var i=0; i<dateset.length; i++) {
			var eachdate = document.createElement('div');
				eachdate.classList.add('timeline-date');
				eachdate.innerHTML = dateset[i];
				for (var j=eventset[i].length-1; j>=0; j--) {
					var eachtime = document.createElement('div');
					var eventname = 'undefined';
					switch (eventset[i][j][2]) {
						case 'sign-in':
							eventname = 'Signed In';
							break;
						case 'sign-out':
							eventname = 'Signed Out';
							break;
						case 'sent-tech':
							eventname = 'Sent to Tech';
							break;
					}
					eachtime.innerHTML = get12time(eventset[i][j][3])+" - "+eventname;
					eachtime.setAttribute('onclick',"selectComments("+i+","+j+")");
					if (eventset[i][j][4] != null) {
						eachtime.classList.add('hascomments');
					}
					eachdate.appendChild(eachtime);
				}
			wrap.appendChild(eachdate);
		}
	}
	comments_eventset = eventset;
}
var commentsrow;
function selectComments(datenum,timenum) {
	commentsel = [datenum,timenum];
	var row = comments_eventset[datenum][timenum];
	var cbox = document.getElementById('comments-box');
	cbox.value = row[4];
	cbox.disabled = false;
	cbox.setAttribute('oninput','commentsChange('+datenum+','+timenum+')');
	var flaglist = document.getElementById('comments-flags');
	for (var i=0; i<flaglist.childElementCount; i++) {
		if (row[5+i]){
			flaglist.children[i].classList.add('yes');
		} else {
			flaglist.children[i].classList.remove('yes');
		}
	}
	var wrap = document.getElementById('student-history-wrapper');
	for (var i=0; i<wrap.childElementCount; i++) {
		for (var j=0; j<wrap.children[i].childElementCount; j++) {
			wrap.children[i].children[j].classList.remove('selected');
		}
	}
	wrap.children[datenum].children[wrap.children[datenum].childElementCount-1-timenum].classList.add('selected');
}

var commentsChangeTimeout;
function commentsChange(datenum,timenum) {
	var row = comments_eventset[datenum][timenum];
	var newval = document.getElementById('comments-box').value;
	if (commentsChangeTimeout != false) { //not waiting for gvz
		if (commentsChangeTimeout != null) { //timeout is set
			clearTimeout(commentsChangeTimeout()); //clear and start new one
			comments_eventset[datenum][timenum][4] = newval;
			commentsChangeTimeout = setTimeout(saveCommentsChange(row,newval),1000);
		} else { //timeout is not set but waiting for gvz
			comments_eventset[datenum][timenum][4] = newval;
			commentsChangeTimeout = setTimeout(saveCommentsChange(row,newval),1000); //start one
		}
	}
}
function saveCommentsChange(row,value) {
	updateComment(row[0],row[2],row[3],value);
	document.getElementById('comments-status').innerText = "Saving changes...";
	commentsChangeTimeout = false; //waiting for gvz
}
function catchUpdateComment() {
	var cs = document.getElementById('comments-status');
	document.getElementById('comments-status').innerText = "";
	commentsChangeTimeout = null; //no longer waiting for gvz
}

function onAuthUpdate() {
	selectDatabaseIdFromUrl();
	updateTodaysDate();
	if (!(GoogleAuth.isSignedIn.get())) {
		showError('auth-lost');
	}
}
</script>
