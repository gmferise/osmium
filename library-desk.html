<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Osmium</title>
		<link href="style.css" rel="stylesheet" type ="text/css"/>
		<link href="favicon.ico" rel="icon" type="image/png">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
		<script src="scripts.js"></script> 
		<script src="https://www.gstatic.com/charts/loader.js"></script>
		<script>
			google.charts.load('current');
		</script>
		<script async defer src="https://apis.google.com/js/api.js" 
			onload="this.onload=function(){};loadAuth()" 
			onreadystatechange="if (this.readyState === 'complete') this.onload()">
		</script>
		<!-- Vue Styling -->
		<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined|Material+Icons+Round" rel="stylesheet">
		<!-- <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet"> -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
	</head>
	<body class="color-bg-main">
		
		<div class="split-left pretty-scrollbar-dark">
			<div class="small-spacer"></div>
			<div class='middle-wrapper'>
				<div id='searchbar'>
					<i class="material-icons">search</i>
					<input type='text' id='searchfield' placeholder="Search"></input>
				</div>
			</div>
			<div class='middle-wrapper'>
				<div id='sortbar' class='sort-time-down'>
					<div id='sort-name' class="tablecell">
						<button onclick="toggleSort('sort-name');">
							<div class="sortfield">Name</div>
							<div class="updown">
							</div>
						</button>
					</div>
					<div id='sort-time' class="tablecell">
						<button onclick="toggleSort('sort-time');">
							<div class="sortfield">Time</div>
							<div class="updown">
							</div>
						</button>
					</div>
				</div>
			</div>
			<div id='cards-wrapper'>
				<div class="null-spacer" id="insert-cards"></div>
			</div>
		</div>
		
		<div class="split-right">
			<div id="overview-table" onclick="updateTodaysDate()">
				<div class="tablerow">
					<div id="todays-date" class="title-center">
						<div class="center-h medium-text">Loading...</div>
						<div class="center-h medium-text"></div>
						<div class="center-h medium-text" style="padding-bottom:10px;"></div>
					</div>
				</div>
				
				<div class="tablerow">
					<div class="title-center medium-text">In the Library</div>
					<div class="half-pair">
						<div class="left">
							<div class="large-text">10</div>
							<div class="small-text">Checked In</div>
						</div>
						<div class="middle"></div>
						<div class="right">
							<div class="large-text">2</div>
							<div class="small-text">In Tech</div>
						</div>
					</div>
				</div>
				
				<div class="tablerow">
					<div class="title-center medium-text">Today's Traffic</div>
					<div class="half-pair">
						<div class="left">
							<div class="large-text">23</div>
							<div class="small-text">Students</div>
						</div>
						<div class="middle"></div>
						<div class="right">
							<div class="large-text">5</div>
							<div class="small-text">Tech Issues</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>

<script>
function showError(errorname) {
	switch (errorname) {
		case 'no-url-database':
			throw new Error("CRITICAL ERROR: No database selected.");
			break;
		case 'auth-lost':
			throw new Error("CRITICAL ERROR: Authentication lost.");
			break;
		case 'db-get-fail':
			throw new Error("ERROR: Could not update event list.");
	}
}

function get12time(date) {
	var hours = date.getHours();
	var minutes = date.getMinutes();
	var ampm = hours >= 12 ? 'pm' : 'am';
	hours = hours % 12;
	hours = hours ? hours : 12; // the hour '0' should be '12'
	minutes = minutes < 10 ? '0'+minutes : minutes;
	var strTime = hours + ':' + minutes + ' ' + ampm;
	return strTime;
}
	
var cards = [];
function cardObjectFromElement(element,numParents) {
	var el = element;
	if (numParents == null) {
		numParents = 0;
	}
	for (var i=0; i<numParents; i++) {
		el = el.parentElement;
	}
	return cards[Array.from(el.parentElement.children).indexOf(el)-1];
}

//OBJECT - Card
function new_Card(studentId, studentName, eventName, timestamp, comments, flags, isSentToTech) {
	const obj = {};
	obj.id = studentId;
	obj.name = studentName;
	obj.event = eventName;
	obj.time = timestamp;
	obj.comments = comments;
	obj.flags = flags;
	obj.tech = isSentToTech;
	
	obj.isNew = false;
	
	//create card
	var wrap = document.createElement('div');
		wrap.classList.add('check-card');
		var btn = document.createElement('button');
			btn.setAttribute('onclick','cardObjectFromElement(this,1).clickAction();');
			var hover = document.createElement('div');
				hover.classList.add('tooltip');
			btn.appendChild(hover);
		wrap.appendChild(btn);
		var txtwrap = document.createElement('div');
			txtwrap.classList.add('text-holder');
			var txtmed = document.createElement('div');
				txtmed.classList.add('medium-text');
				txtmed.innerHTML = obj.name;
				var hover = document.createElement('div');
					hover.classList.add('tooltip');
				txtmed.appendChild(hover);
			txtwrap.appendChild(txtmed);
			var txtsml = document.createElement('div');
				txtsml.classList.add('small-text');
				txtsml.innerHTML = get12time(obj.time);
			txtwrap.appendChild(txtsml);
		wrap.appendChild(txtwrap);
		
	obj.card = wrap;
	
	obj.showComments = function() {
		var popup = document.createElement('div');
			popup.classList.add('card-popup');
			var container = document.createElement('div');
			container.classList.add('card-popup-container','color-bg-main');
				var close = document.createElement('button');
					close.classList.add('close','material-icons');
					close.innerHTML = 'close';
					close.setAttribute('onclick','this.parentElement.parentElement.remove()');
				container.appendChild(close);
				var header = document.createElement('div');
					header.classList.add('title-center');
					header.innerHTML = obj.name;
				container.appendChild(header);
				var center = document.createElement('div');
					center.classList.add('middle-wrapper');
					var leftside = document.createElement('div');
						leftside.classList.add('left');
						
							var leftlabel = document.createElement('div');
								leftlabel.classList.add('title-left');
								leftlabel.innerHTML = "Student History";
							leftside.appendChild(leftlabel);
							
							var historylist = document.createElement('div');
								historylist.classList.add('pretty-scrollbar-dark');
							
								//[ [day, [time,type],[time,type],[time,type]...],[...] ]
								var data = [
								[new Date(2020,0,2),[new Date(new Date().setMinutes(0)),"Checked In"],[new Date(new Date().setMinutes(10)),"Sent to Tech"],[new Date(new Date().setMinutes(20)),"Checked Out"]],
								[new Date(2020,0,1),[new Date(new Date().setMinutes(2)),"Checked In"],[new Date(new Date().setMinutes(12)),"Checked Out"],[new Date(new Date().setMinutes(20)),"Checked In"],[new Date(new Date().setMinutes(26)),"Sent to Tech"],[new Date(new Date().setMinutes(38)),"Checked Out"]]
								]
								//todo pull person data
								
								for (var i=0; i<data.length; i++) {
									var eachdate = document.createElement('div');
									eachdate.classList.add('timeline-date');
									eachdate.innerHTML = data[i][0].toLocaleString('en-US',{weekday:'long',month:'long',day:'numeric'});
									for (var j=1; j<data[i].length; j++) {
										var eachtime = document.createElement('div');
										eachtime.innerHTML = get12time(data[i][j][0])+" - "+data[i][j][1];
										eachdate.appendChild(eachtime);
									}
									historylist.appendChild(eachdate);
								}
								var t = document.createElement('div')
								t.classList.add('TEST-scroll');
								historylist.appendChild(t);
							leftside.appendChild(historylist)
							
					center.appendChild(leftside);
					var rightside = document.createElement('div');
						rightside.classList.add('right');
						var rightlabel = document.createElement('div');
							rightlabel.classList.add('title-center');
							rightlabel.innerHTML = "Notes for Event";
						rightside.appendChild(rightlabel);
						var commentsbox = document.createElement('textarea');
							commentsbox.setAttribute('placeholder','Click to add notes');
						rightside.appendChild(commentsbox);
					center.appendChild(rightside);
				container.appendChild(center);
			popup.appendChild(container);
		document.body.appendChild(popup);
	}
	
	//click the card's button - uses card's properties to determine action
	obj.clickAction = function() {
		if (!(obj.tech) && (obj.event=="sign-in")) {
			//todo send "moved to tech" query
			//obj.updateStatusAndColor("sign-in",true);
			pushEvent(obj.id, 'sent-tech', '', [false,false,false,false]);
			obj.card.classList.add('loading');
		} else {
			obj.showComments();
		}
	}
	
	obj.playRefreshAnimation = function() {
		if (obj.isNew) {
			obj.card.classList.add('anim-in');
			setTimeout(function() {
				obj.card.classList.remove('anim-in');
			},500);
			isNew = false;
		} else {
			obj.card.classList.add('anim-refresh');
			setTimeout(function() {
				obj.card.classList.remove('anim-refresh');
			},500);
		}
	}
	
	//provide status name ("in"|"out") and tech status (true|false) to update proper styling and object's properties
	obj.updateStatusAndColor = function(statusName, isSentToTech, timestamp) {
		console.log("updated w/ ts:");
		console.log(timestamp);
		if (timestamp != null) {
			obj.time = timestamp;
		}
		var newcolor = "color-card_"+statusName;
		if (isSentToTech) {
			newcolor += '_tech';
		}
		obj.card.children[1].children[1].textContent = get12time(obj.time);
		obj.card.classList = "";
		obj.card.classList.add('check-card');
		obj.card.classList.add(newcolor);
		obj.event = statusName;
		obj.tech = isSentToTech;
	}
	obj.updateStatusAndColor(obj.event,obj.tech);
	
	//insert into cards list at top
	obj.insertIntoCards = function() {
		document.getElementById("insert-cards").insertAdjacentElement('afterEnd',obj.card);
	};
	
	return obj;
}

function randomDate() {
	var now = new Date();
	now.setHours(parseInt(Math.random()*24));
	now.setMinutes(parseInt(Math.random()*60));
	now.setSeconds(parseInt(Math.random()*60));
	return now;
}

function toggleSort(toggle) {
	var el = document.getElementById('sortbar');
	var current = el.classList[0];
	el.classList.remove(current);
	if (toggle == current.substring(0,9)) {
		if (current.substring(10) == "up") {
			el.classList.add(current.substring(0,9)+"-down");
			cards = cards.reverse();
			repackCards();
		} else {
			el.classList.add(current.substring(0,9)+"-up");
			cards = cards.reverse();
			repackCards();
		}
	} else if (current.substring(5,9)=="name") {
		el.classList.add("sort-time-down");
		cards = quickSort(cards, 0, cards.length-1, false);
		repackCards();
	} else {
		el.classList.add("sort-name-down");
		cards = quickSort(cards, 0, cards.length-1, true);
		repackCards();
	}
}
function reSort() {
	var el = document.getElementById('sortbar');
	var current = el.classList[0];
	
	if (current.substring(0,9) == "sort-time") {
		cards = quickSort(cards, 0, cards.length-1, false);
		if (current.substring(10) == "up") {
			cards = cards.reverse();
		}
		repackCards();
	} else {
		cards = quickSort(cards, 0, cards.length-1, true);
		if (current.substring(10) == "up") {
			cards = cards.reverse();
		}
		repackCards();
	}	
}
function repackCards(cardslist) {
	var el = document.getElementById('cards-wrapper');
	el.innerHTML = '';
	var ns = document.createElement('div');
	ns.classList.add('null-spacer');
	ns.setAttribute('id','insert-cards');
	el.appendChild(ns);
	for (var i=cards.length-1; i>=0; i--) {
		cards[i].insertIntoCards();
	}
	
}

function QSswap(items, leftIndex, rightIndex){
    var temp = items[leftIndex];
    items[leftIndex] = items[rightIndex];
    items[rightIndex] = temp;
}
function QSpartition_name(items, left, right) {
    var pivot   = items[Math.floor((right + left) / 2)], //middle element
        i       = left, //left pointer
        j       = right; //right pointer
    while (i <= j) {
        while (items[i].name < pivot.name) {
            i++;
        }
        while (items[j].name > pivot.name) {
            j--;
        }
        if (i <= j) {
            QSswap(items, i, j); //sawpping two elements
            i++;
            j--;
        }
    }
    return i;
}
function QSpartition_time(items, left, right) {
    var pivot   = items[Math.floor((right + left) / 2)], //middle element
        i       = left, //left pointer
        j       = right; //right pointer
    while (i <= j) {
        while (items[i].time > pivot.time) {
            i++;
        }
        while (items[j].time < pivot.time) {
            j--;
        }
        if (i <= j) {
            QSswap(items, i, j); //sawpping two elements
            i++;
            j--;
        }
    }
    return i;
}
function quickSort(items, left, right, name) {
    var index;
    if (items.length > 1) {
		if (name) {
			index = QSpartition_name(items, left, right); //index returned from partition
		} else {
			index = QSpartition_time(items, left, right); //index returned from partition
		}
		
        if (left < index - 1) { //more elements on the left side of the pivot
            quickSort(items, left, index - 1, name);
        }
        if (index < right) { //more elements on the right side of the pivot
            quickSort(items, index, right, name);
        }
    }
    return items;
}

var lastResultsRefreshTime = new Date();
lastResultsRefreshTime.setHours(0);
lastResultsRefreshTime.setMinutes(0);
lastResultsRefreshTime.setSeconds(0);
lastResultsRefreshTime.setMilliseconds(0);
function updateTodaysDate() {
	//var now = new Date(new Date().getTime()+Math.random()*100000000000)
	var now = new Date();
	var s = now.toLocaleString('en-US',{weekday:'long',month:'long',day:'numeric'});
	var d = s.split(", ");
	d[0] += ",";
	d.push(get12time(now));
	var here = document.getElementById('todays-date');
	for (var i=0; i<d.length; i++) {
		here.children[i].innerHTML = d[i];
	}
	getEventsAfter(lastResultsRefreshTime);
	lastResultsRefreshTime = new Date();
	setTimeout(function(){updateTodaysDate();},60000-((now.getSeconds()*1000)+now.getMilliseconds())); //timeout to refresh on next minute
}
function catchPushEvent(name, type, flags) {
	updateTodaysDate();
}

var preids = [];
var precards = [];
var finalcards = [];

function catchEventsAfter(response) {
	var dt = response.getDataTable();
	
	if (dt == null) {
		showError('db-get-fail');
		return;
	}
	
	for (var i=0; i<dt.getNumberOfRows(); i++) {
		var row = [];
		for (var j=0; j<dt.getNumberOfColumns(); j++) {
			row.push(dt.getValue(i,j));
		}
		
		var index = preids.indexOf(row[0]);
		if (index == -1) {
			if (row[2] == 'sign-in') {
				preids.push(row[0]);
				precards.push([row]);
			}
		} else {
			var last = precards[index][precards[index].length-1][2];
			if (last == 'sign-in') {
				if (row[2] == 'sent-tech') { //sign-in -> tech
					precards[index].push(row);
				} else if (row[2] == 'sign-out') { //sign-in -> sign-out
					var c = row;
					c = new_Card(c[0],c[1],c[2],c[3],c[4],[c[5],c[6],c[7],c[8]],false);
					c.playRefreshAnimation();
					finalcards.push(c);
					preids.pop(index);
					precards.pop(index);
				} else if (row[2] == 'sign-in') { //sign-in -> sign-in (just end the first one);
					var c = precards[index][precards[index].length-1];
					c = new_Card(c[0],c[1],'sign-out',c[3],c[4],[c[5],c[6],c[7],c[8]],false);
					c.playRefreshAnimation();
					finalcards.push(c);
					precards[index] = [row];
				}
			} else if (last == 'sent-tech') {
				if (row[2] == 'sign-out') {
					var c = row;
					c = new_Card(c[0],c[1],c[2],c[3],c[4],[c[5],c[6],c[7],c[8]],true);
					c.playRefreshAnimation();
					finalcards.push(c);
					preids.pop(index);
					precards.pop(index);
				} else if (row[2] == 'sign-in') { //tech -> sign-in (end the first);
					var c = precards[index][precards[index].length-1];
					finalcards.push(new_Card(c[0],c[1],'sign-out',c[3],c[4],[c[5],c[6],c[7],c[8]],true));
					precards[index] = [row];
				}
			}
		}
		
	}
	var tmpcards = [];
	for (var i=0; i<precards.length; i++) {
		var c = precards[i][precards[i].length-1];
		c = new_Card(c[0],c[1],c[2],c[3],c[4],[c[5],c[6],c[7],c[8]],(c[2]=='sent-tech'));
		c.playRefreshAnimation();
		tmpcards.push(c);
	}
	cards = finalcards.concat(tmpcards);
	repackCards(cards);
	reSort();
}
function onAuthUpdate() {
	selectDatabaseIdFromUrl();
	updateTodaysDate();
	if (!(GoogleAuth.isSignedIn.get())) {
		showError('auth-lost');
	}
}
</script>
